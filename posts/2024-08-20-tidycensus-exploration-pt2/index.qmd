---
title: "Part Two: Exploring the tidycensus R package"
description: "This post uses the tidycensus package to access the Census API and visualize data"
author:
  - name: Mickey Rafa
    url: https://mrafa3.github.io/
    #orcid: 0000-0002-5300-3075
date: 08-20-2024
categories: [R, tidyverse, mapping, gt, tidycensus, api] # self-defined categories
#citation: 
 # url: https://mrafa3.github.io/posts/2024-07-15-wikipedia-international-mens-soccer/ 
# image: us_child_poverty_map.png
draft: true # setting this to `true` will prevent your post from appearing on your listing page until you're ready!
editor: 
  markdown: 
    wrap: 72
---

# Introduction

In [Part One](https://mrafa3.github.io/posts/2024-08-13-tidycensus-exploration/), I demonstrated how to fetch data and do some basic analysis of U.S. Census data.



## Setup

```{r libraries, include=TRUE, warning=FALSE, message=FALSE}
library(tidyverse)
library(tidycensus)
library(scales)
library(janitor)
library(gt)
library(usmap)

# census_api_key('INSERT KEY HERE')
```

```{r my.theme, include=TRUE, echo=FALSE}
my.theme <- theme(
  plot.title = ggtext::element_textbox_simple(face="bold", size=24, margin=margin(b=5)),
  plot.subtitle = ggtext::element_textbox_simple(color="#444444", size=14, margin=margin(b=10)),
  plot.caption = ggtext::element_textbox_simple(color="#444444"),
  axis.title = element_text(color="black", face="bold", size=12), 
  axis.text = element_text(color="black", size=18), 
  axis.ticks = element_blank(), 
  plot.background = element_rect(fill = 'white'),
  panel.background = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.border = element_blank(), 
  legend.title=element_blank(), 
  legend.text = element_text(color="black", size=12, hjust=0),
  legend.position = 'top',
  strip.text = element_text(color="black", size=14))
```

For this demo, I'll use the following series:

-   *B01001_003*: Estimate!!Total:!!Male:!!Under 5 years (all racial
    groups)
-   *B01001_027*: Estimate!!Total:!!Female:!!Under 5 years (all racial
    groups)
-   *B17001_004*: Estimate!!Total:!!Income in the past 12 months below
    poverty level:!!Male:!!Under 5 years
-   *B17001_018*: Estimate!!Total:!!Income in the past 12 months below
    poverty level:!!Female:!!Under 5 years


```{r get_acs, include=FALSE}
df <- get_acs(geography = 'county',
              # for this demo, using the state argument to only fetch Colorado
              state = "Colorado",
              variables = c('B01001_003', 'B01001_027', 'B17001_004', 'B17001_018'),
              year = 2022,
              output = 'wide')
```

To make the data more user-friendly, I'll update the column names of the
table.

```{r update_colnames, include=TRUE}
name_cols <- c('geoid', 'county_state', 
               'u5_male_estimate', 'u5_male_moe', 
               'u5_female_estimate', 'u5_female_moe',
               'u5_male_pov_estimate', 'u5_male_pov_moe',
               'u5_female_pov_estimate', 'u5_female_pov_moe')

colnames(df) <- name_cols
```

And for this exercise, I'll also drop the margin of error fields, since
I'm not doing a statistical analysis that would require it.

```{r drop_cols, include=TRUE}
df <- df %>% 
  select(-contains("moe"))
```


Next, I'll create some fields to combine gender-based poverty estimates
and calculate a percent of the child population measure.

```{r df_mutate, include=TRUE}
(df <- df %>% 
  mutate(u5_pop_total = u5_male_estimate + u5_female_estimate,
         u5_pov_total = u5_male_pov_estimate + u5_female_pov_estimate,
         u5_perc_in_poverty = u5_pov_total / u5_pop_total))
```

```{r df_rank, include=FALSE}
df_rank <- df %>% 
  mutate(rank_u5_poverty = rank(-u5_pov_total))
  #        state_group = if_else(rank_u5_poverty <= 15, state, 'Remaining States')) %>% 
  # group_by(state_group) %>% 
  # summarise(u5_pov_total = sum(u5_pov_total))
```

```{r df_rank_2, include=FALSE}
# df_rank %>% 
#   arrange(-u5_pov_total) %>% 
#   pull(state_group)
# 
# state_order <- c("Texas", "California", "New York", "Florida", "Ohio", "Georgia", "Illinois", 
#                  "North Carolina", "Pennsylvania", "Michigan", 
#                   "Tennessee", "Louisiana", "Arizona", "Indiana", "New Jersey", "Remaining States")
```

```{r df_rank_viz, include=FALSE}
# df_rank %>% 
#   mutate(state_group = factor(state_group, levels = rev(state_order))) %>% 
#   ggplot(.,
#          aes(x=u5_pov_total,
#              y=state_group)) + 
#   geom_col()
```

# Mapping

The `usmapp::` package makes rendering a map of the US quick and easy.
Though it's not meant to replace `sf::` or packages that allow for more
sophisticated maps, it does allow for a quick way to make a U.S. map.
For this demo, I'll plot the state-level poverty data that I collected
and manipulated in earlier steps.

This shows that child poverty is concentrated in southern and
southeastern states (as a percent of the child population).

```{r plot_u5_poverty, include=TRUE, fig.align='center'}
(perc_poverty_map <- plot_usmap(regions = 'counties',
                                include = "CO", 
                                data = df %>% rename(fips = geoid),
                                values = 'u5_perc_in_poverty') + 
  # scale_fill_viridis_c() + 
  scale_fill_viridis_c(option = 'inferno', labels = scales::percent_format()) + 
  labs(title = md("**Estimated child poverty in U.S. states in 2021**"),
       subtitle = "as a % of the total child population under 5 y.o.",
       caption = "Source: 2021 American Community Survey") %>%
  theme(legend.position = 'top',
        legend.title = element_blank()))
```

# Great tables with gt::

```{r read_regions, include=TRUE, echo=FALSE, message=FALSE}
co_regions <- read_csv('.//data/colorado_regions.csv') %>% 
  mutate(region = as.factor(region))
```

```{r clean_df_colorado, include=TRUE, echo=FALSE}
df <- df %>%
  mutate(county = str_remove(county_state, " County.*")) %>% 
  select(county, everything()) %>% 
  left_join(x=.,
            y=co_regions,
            by='county') 

# df <- df %>% 
#   mutate(region = factor(region, levels = desired_order))
```


```{r create_df_tbl, include=TRUE, fig.width=6.2, fig.height=20, fig.align='center'}
(df_tbl <- df %>% 
  select(county, region, u5_pov_total, u5_pop_total, u5_perc_in_poverty) %>% 
  arrange(-u5_perc_in_poverty) %>% 
  gt(groupname_col = "region") %>% 
  cols_label(county = 'County',
               u5_pop_total = 'Total children < 5 y.o.',
               u5_pov_total = 'Total children < 5 y.o. living in poverty in last 12 mos.',
               u5_perc_in_poverty = '% of children < 5 y.o. living in poverty in last 12 mos.') %>% 
  # formatting numeric fields
  fmt_number(columns = c(u5_pop_total, u5_pov_total), decimals = 0, use_seps = TRUE) %>% 
  fmt_percent(columns = u5_perc_in_poverty, decimals = 1) %>%  
  #add table title
  tab_header(title = md("**Estimated child poverty in Colorado by county in 2022**")) %>% 
  tab_source_note(source_note = "Data from 2022 American Community Survey from the U.S. Census Bureau") %>% 
  #apply new style to all column headers
  tab_style(
    locations = cells_column_labels(columns = everything()),
    style = list(
      #thick border
      cell_borders(sides = "bottom", weight = px(3)),
      #make text bold
      cell_text(weight = "bold")
    )
  ) %>% 
  #apply different style to title
  tab_style(locations = cells_title(groups = "title"),
            style = list(
              cell_text(weight = "bold", size = 24)
            )) %>% 
  data_color(
    columns = u5_perc_in_poverty,
    palette = viridis::inferno(100)
  ) %>% 
  opt_all_caps() %>% 
  opt_table_font(
    font = list(
      google_font("Chivo"),
      default_fonts()
    )
  ) %>% 
  tab_options(
    #remove border between column headers and title
    column_labels.border.top.width = px(3),
    column_labels.border.top.color = "transparent",
    #remove border around the table
    table.border.top.color = "transparent",
    table.border.bottom.color = "transparent",
    #adjust font sizes and alignment
    source_notes.font.size = 12,
    heading.align = "left"
  )
)
```




```{r df_county, include=FALSE}
# considering a map like this one: https://observablehq.com/@observablehq/plot-us-bubble-map?intent=fork
```

# Conclusion

In this first `tidycensus::` post, I demonstrated:

-   How to fetch data from the U.S. Census Bureau
-   A simple way to search for the type of data that you're interested
    in exploring
-   How to use some of the `tidycensus::` functions and arguments to
    support in data wrangling
-   How to make a simple map using the `usmap::` package
-   How to make a clean and visually appealing table using the `gt::`
    package
