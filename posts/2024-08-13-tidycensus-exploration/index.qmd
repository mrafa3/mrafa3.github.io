---
title: "Exploring the tidycensus R package"
description: "This post uses the tidycensus package to access the Census API and visualize data"
author:
  - name: Mickey Rafa
    url: https://mrafa3.github.io/
    #orcid: 0000-0002-5300-3075
date: 08-13-2024
categories: [R, tidyverse, mapping] # self-defined categories
#citation: 
 # url: https://mrafa3.github.io/posts/2024-07-15-wikipedia-international-mens-soccer/ 
# image: map_example.png
draft: true # setting this to `true` will prevent your post from appearing on your listing page until you're ready!
editor: 
  markdown: 
    wrap: 72
---

# Introduction


## Setup

```{r my.theme, include=TRUE}
my.theme <- theme(
  plot.title = ggtext::element_textbox_simple(face="bold", size=24, margin=margin(b=5)),
  plot.subtitle = ggtext::element_textbox_simple(color="#444444", size=14, 
                                                       margin=margin(b=10)),
  plot.caption = ggtext::element_textbox_simple(color="#444444"),
  axis.title = element_text(color="black", face="bold", size=12), 
  axis.text = element_text(color="black", size=18), 
  axis.ticks.y = element_blank(), 
  plot.background = element_rect(fill = 'white'),
  panel.background = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.border = element_blank(), 
  legend.title=element_blank(), 
  legend.text = element_text(color="black", size=12, hjust=0),
  legend.position = 'top',
  strip.text = element_text(color="black", size=14))
```

**Required packages**:

```{r libraries, include=TRUE, warning=FALSE, message=FALSE}
library(tidyverse)
library(tidycensus)
library(scales)

census_api_key('ea0509826dec14205b1260b78cee1e2a22e3b85b')
```

```{r inspect_variables, include=TRUE}
load_variables(2022, "acs1", cache = TRUE)
# used this to search for some Under 5 years variables of interest
# %>% filter(str_detect(label, "Under 5 years"))

# B01001_003 -- 'Estimate!!Total:!!Male:!!Under 5 years' (all racial groups)
# B01001_027 -- 'Estimate!!Total:!!Female:!!Under 5 years' (all racial groups)
# B17001_004 -- 'Estimate!!Total:!!Income in the past 12 months below poverty level:!!Male:!!Under 5 years'
# B17001_018 -- 'Estimate!!Total:!!Income in the past 12 months below poverty level:!!Female:!!Under 5 years'
```

```{r}
?get_acs()

?group_by()
```

Each variable returns the geography, an estimate, and the margin of error ("moe").

There are a bunch of useful helper functions/arguments in the `tidycensus::` package. Some noteworthy ones include:  

* `summary_var=`: often the variable that you want would be made more meaningful as a ratio or with a demonminator. For example, the number of children in poverty could be useful on its own, but you're likely to want to see that series as a percent of the total children. With the summary_var argument, you can tell the function which secondary variable you want to grab in the same API call.
* `ouput=wide`: related to the above, I wanted to look at child poverty in a way that would require multiple summary variables (e.g. the percent of girls *and* boys in poverty). Since you can only have one summary variable, `output='wide'` allows you to grab all of the series that you may need in the same call. 

```{r get_acs, include=TRUE}
df <- get_acs(geography = 'state',
        variables = c('B01001_003', 'B01001_027', 'B17001_004', 'B17001_018'),
        year = 2021,
        output = 'wide')
```

```{r update_colnames, include=TRUE}
name_cols <- c('geoid', 'name', 
               'u5_male_estimate', 'u5_male_moe', 
               'u5_female_estimate', 'u5_female_moe',
               'u5_male_pov_estimate', 'u5_male_pov_moe',
               'u5_female_pov_estimate', 'u5_female_pov_moe')

colnames(df) <- name_cols
```

```{r drop_cols, include=TRUE}
df <- df %>% 
  select(-contains("moe"))
```


```{r}
u5poverty_girls <- get_acs(geography = "state", 
                           variables = "B17001_018", 
                           year = 2021) %>% 
  rename(estimate_poverty_pop = estimate,
         moe_poverty_pop = moe)

u5_girls <- get_acs(geography = "state", 
                    variables = "B01001_027", 
                    year = 2021) %>% 
  rename(estimate_pop = estimate,
         moe_pop = moe)

u5_girls %>% 
  left_join(x=.,
            y=u5poverty_girls,
            by=c('GEOID', 'NAME')) %>% 
  select(-c(variable.x, variable.y)) %>% 
  mutate(perc_poverty = estimate_poverty_pop / estimate_pop) %>% 
  ggplot(
    aes(x=perc_poverty, 
        y=reorder(NAME, perc_poverty))) + 
  geom_point() +
  ggtitle('Percent of Girls (U5) in poverty',
          subtitle = 'from the American Community Survey 2021') + 
  scale_x_continuous(labels = percent)
```

