{
  "hash": "a5a69b616d16ef4fbedabea0bf20fc85",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Query comparison: SQL, R, and Python using Chicago Employees dataset\"\ndescription: \"This post demonstrates how to run these languages in Quarto\"\nauthor:\n  - name: Mickey Rafa\n    url: https://mrafa3.github.io/\n    #orcid: 0000-0002-5300-3075\ndate: 07-24-2024\ncategories: [R, SQL, Python, Quarto, generative-AI] # self-defined categories\n#citation: \n # url: https://mrafa3.github.io/posts/2024-07-15-wikipedia-international-mens-soccer/ \nimage: sql-r-python.png\ndraft: false # setting this to `true` will prevent your post from appearing on your listing page until you're ready!\n---\n\n\n# Introduction\n\n## Purpose\n\n**This project has three purposes**:\n\n1. To show how to run R, SQL, and Python all interchangeably in a Quarto document\n2. To compare the ease of writing code using dplyr (R), SQL, and pandas (Python)\n3. To include some demonstration of SQL in my portfolio (which is often not included but remains a critical skill)\n\n## Setup and data preparation\n\n**Required packages**: \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(httr)           #to fetch the data\nlibrary(readxl)\nlibrary(janitor)        #for the clean_names() function for data cleaning\n# library(sqldf)          #to run SQL in an R code-chunk\nlibrary(reticulate)     #to enable Python within R\nlibrary(DBI)            #to establish in-memory database of R dataframe\nlibrary(RSQLite)        #for SQLite engine\nlibrary(lubridate)      #for functions to handle dates\n```\n:::\n\n\n**About the dataset**:\n\nThis dataset is from data.world, and includes information from Chicago's Department of Human Resources for city employees in 2017. It's a simple dataset to allow for comparisons across languages.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# reading as a temporary file, then saving as df\nGET(\"https://query.data.world/s/hu5dkviuxd6k2ipuhpxjuyuds7aplu?dws=00000\", write_disk(tf <- tempfile(fileext = \".xls\")))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nResponse [https://download.data.world/file_download/wbezchicago/chicago-employee-positions-and-salaries-for-2017/Employee%20Salary%20Data%20as%20of%20Sept.%202017.xls?auth=eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJwcm9kLXVzZXItY2xpZW50Om1yYWZhMyIsImlzcyI6ImFnZW50Om1yYWZhMzo6ODg0MjQ2ZDItMTgzMy00NmZjLTk2YTMtZjQ2MWMzMDJjOTZiIiwiaWF0IjoxNzIxODc0NzgyLCJyb2xlIjpbInVzZXIiLCJ1c2VyX2FwaV9hZG1pbiIsInVzZXJfYXBpX2VudGVycHJpc2VfYWRtaW4iLCJ1c2VyX2FwaV9yZWFkIiwidXNlcl9hcGlfd3JpdGUiXSwiZ2VuZXJhbC1wdXJwb3NlIjpmYWxzZSwidXJsIjoiMjM2ZDZlZGQ3NjdkZmVmOGRjYzM0Mzg3YTExMDQ1N2EzMmU1OGY3ZSJ9.oTr9PF0rrsLdVhewmy2v1vRgYvT0jy_PBmqhmrufaRSB25PEm48ZPxvswiSrZw8bNaACxDWpxwBiJVCVSaM-Zg]\n  Date: 2024-07-26 17:13\n  Status: 200\n  Content-Type: application/vnd.ms-excel\n  Size: 4.72 MB\n<ON DISK>  /var/folders/ck/dmgn8lbx6vl8sl89vlhr0sv00000gn/T//RtmpRFb3T4/filececf58beac81.xls\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- read_excel(tf) %>% \n  #clean_names() to make all column names lowercase\n  clean_names()\n```\n:::\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 32,806\nColumns: 8\n$ name                           <chr> \"AARON,  JEFFERY M\", \"AARON,  KARINA\", …\n$ title                          <chr> \"SERGEANT\", \"POLICE OFFICER (ASSIGNED A…\n$ department                     <chr> \"POLICE\", \"POLICE\", \"FLEET AND FACILITY…\n$ salary_annual                  <dbl> 101442.0, 94122.0, 101592.0, 110064.0, …\n$ original_hire_date             <dttm> 2005-09-26, 2005-09-26, 1991-08-01, 19…\n$ start_date_in_present_position <dttm> 2016-06-01, 2017-04-16, 2000-05-01, 20…\n$ salary_basis                   <chr> \"SALARY\", \"SALARY\", \"SALARY\", \"SALARY\",…\n$ employment_category            <chr> \"Fulltime-Regular\", \"Fulltime-Regular\",…\n```\n\n\n:::\n:::\n\n\n## Setting up Python and SQL to execute\n\nThe `DBI::` package allows you to create an in-memory database to query against. The [DBI project site](https://r-dbi.org/) is a great place to learn more about it. I'll start by doing some initial setup and establishing the connection between the R dataframe and the SQL table name that I'll query.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncon <- DBI::dbConnect(SQLite(), \":memory:\")\nDBI::dbWriteTable(conn = con, name = \"df\", value = df)\n```\n:::\n\n\nThe `reticulate::` package allows for executing Python code in an R environment. The [reticulate project site](https://rstudio.github.io/reticulate/) includes useful examples for getting up and running with Python in R. This package includes an `r_to_py()` function that is needed to convert an R dataframe into a pandas dataframe.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npy$df <- r_to_py(df)\n```\n:::\n\n\nWhen inserting a code chunk to your Markdown file, it originally defaults to '{r}'. You can simply change this to 'python' or 'sql' and, with the above set up, the code works beautifully in a Quarto document!\n\nIn the sections that follow, I used ChatGPT to generate prompts as querying exercises. For the initial code chunks, I'll display the code chunk options so that these can be replicated (if you are following along); for all prompts that follow, I'll hide these options for a cleaner reading experience.\n\n# 1. Basic Selection and Filtering:\n\n**Retrieve all records of employees who have the job title \"POLICE OFFICER\".**\n\n\n\n````{.default}\n```{sql basic1.1_sql, connection=\"con\", include=TRUE}\nselect *\nfrom df\nwhere title = 'POLICE OFFICER'\n```\n````\n\n::: {.cell}\n<div class=\"knitsql-table\">\n\n\nTable: Displaying records 1 - 10\n\n|name                  |title          |department | salary_annual| original_hire_date| start_date_in_present_position|salary_basis |employment_category |\n|:---------------------|:--------------|:----------|-------------:|------------------:|------------------------------:|:------------|:-------------------|\n|ABBATE,  TERRY M      |POLICE OFFICER |POLICE     |         93354|          818035200|                      818035200|SALARY       |Fulltime-Regular    |\n|ABDALLAH,  ZAID       |POLICE OFFICER |POLICE     |         84054|         1354233600|                     1354233600|SALARY       |Fulltime-Regular    |\n|ABDELHADI,  ABDALMAHD |POLICE OFFICER |POLICE     |         87006|         1166400000|                     1166400000|SALARY       |Fulltime-Regular    |\n|ABDELMAJEID,  AZIZ    |POLICE OFFICER |POLICE     |         84054|         1209340800|                     1209340800|SALARY       |Fulltime-Regular    |\n|ABEJERO,  JASON V     |POLICE OFFICER |POLICE     |         90024|          940809600|                      940809600|SALARY       |Fulltime-Regular    |\n|ABFALL,  RICHARD C    |POLICE OFFICER |POLICE     |         48078|         1494892800|                     1494892800|SALARY       |Fulltime-Regular    |\n|ABNEY,  PATRICK       |POLICE OFFICER |POLICE     |         72510|         1435536000|                     1435536000|SALARY       |Fulltime-Regular    |\n|ABOUASSI,  CHADI      |POLICE OFFICER |POLICE     |         48078|         1494892800|                     1494892800|SALARY       |Fulltime-Regular    |\n|ABRAHAM,  NANCY A     |POLICE OFFICER |POLICE     |         76266|         1398643200|                     1398643200|SALARY       |Fulltime-Regular    |\n|ABRAM,  ANTHONY A     |POLICE OFFICER |POLICE     |         68616|         1466985600|                     1466985600|SALARY       |Fulltime-Regular    |\n\n</div>\n:::\n\n\n````{.default}\n```{r basic1.1_r, include=TRUE}\ndf %>% \n  filter(title == 'POLICE OFFICER')\n```\n````\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 9,213 × 8\n   name                  title      department salary_annual original_hire_date \n   <chr>                 <chr>      <chr>              <dbl> <dttm>             \n 1 ABBATE,  TERRY M      POLICE OF… POLICE             93354 1995-12-04 00:00:00\n 2 ABDALLAH,  ZAID       POLICE OF… POLICE             84054 2012-11-30 00:00:00\n 3 ABDELHADI,  ABDALMAHD POLICE OF… POLICE             87006 2006-12-18 00:00:00\n 4 ABDELMAJEID,  AZIZ    POLICE OF… POLICE             84054 2008-04-28 00:00:00\n 5 ABEJERO,  JASON V     POLICE OF… POLICE             90024 1999-10-25 00:00:00\n 6 ABFALL,  RICHARD C    POLICE OF… POLICE             48078 2017-05-16 00:00:00\n 7 ABNEY,  PATRICK       POLICE OF… POLICE             72510 2015-06-29 00:00:00\n 8 ABOUASSI,  CHADI      POLICE OF… POLICE             48078 2017-05-16 00:00:00\n 9 ABRAHAM,  NANCY A     POLICE OF… POLICE             76266 2014-04-28 00:00:00\n10 ABRAM,  ANTHONY A     POLICE OF… POLICE             68616 2016-06-27 00:00:00\n# ℹ 9,203 more rows\n# ℹ 3 more variables: start_date_in_present_position <dttm>,\n#   salary_basis <chr>, employment_category <chr>\n```\n\n\n:::\n:::\n\n\n````{.default}\n```{python basic1.1_python, include=TRUE}\ndf[df['title'] == 'POLICE OFFICER']\n```\n````\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n                        name           title  ... salary_basis  employment_category\n10          ABBATE,  TERRY M  POLICE OFFICER  ...       SALARY     Fulltime-Regular\n12           ABDALLAH,  ZAID  POLICE OFFICER  ...       SALARY     Fulltime-Regular\n13     ABDELHADI,  ABDALMAHD  POLICE OFFICER  ...       SALARY     Fulltime-Regular\n15        ABDELMAJEID,  AZIZ  POLICE OFFICER  ...       SALARY     Fulltime-Regular\n24         ABEJERO,  JASON V  POLICE OFFICER  ...       SALARY     Fulltime-Regular\n...                      ...             ...  ...          ...                  ...\n32800        ZYGMUNT,  DAWID  POLICE OFFICER  ...       SALARY     Fulltime-Regular\n32801   ZYLINSKA,  KATARZYNA  POLICE OFFICER  ...       SALARY     Fulltime-Regular\n32802     ZYMANTAS,  LAURA C  POLICE OFFICER  ...       SALARY     Fulltime-Regular\n32803      ZYMANTAS,  MARK E  POLICE OFFICER  ...       SALARY     Fulltime-Regular\n32804    ZYRKOWSKI,  CARLO E  POLICE OFFICER  ...       SALARY     Fulltime-Regular\n\n[9213 rows x 8 columns]\n```\n\n\n:::\n:::\n\n\n**List the names and salaries of employees whose annual salary is greater than $100,000.**\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nselect name, salary_annual\nfrom df\nwhere salary_annual > 100000\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: Displaying records 1 - 10\n\n|name                     | salary_annual|\n|:------------------------|-------------:|\n|AARON,  JEFFERY M        |        101442|\n|AARON,  KIMBERLEI R      |        101592|\n|ABAD JR,  VICENTE M      |        110064|\n|ABBATEMARCO,  JAMES J    |        103350|\n|ABDELLATIF,  AREF R      |        102228|\n|ABDUL-KARIM,  MUHAMMAD A |        111492|\n|ABDULLAH,  KEVIN         |        114846|\n|ABOUELKHEIR,  HASSAN A   |        110064|\n|ABRAHAM,  GIRLEY T       |        110064|\n|ABRAMSKI,  JOHN E        |        128970|\n\n</div>\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  filter(salary_annual > 100000) %>% \n  select(name, salary_annual)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6,091 × 2\n   name                     salary_annual\n   <chr>                            <dbl>\n 1 AARON,  JEFFERY M               101442\n 2 AARON,  KIMBERLEI R             101592\n 3 ABAD JR,  VICENTE M             110064\n 4 ABBATEMARCO,  JAMES J           103350\n 5 ABDELLATIF,  AREF R             102228\n 6 ABDUL-KARIM,  MUHAMMAD A        111492\n 7 ABDULLAH,  KEVIN                114846\n 8 ABOUELKHEIR,  HASSAN A          110064\n 9 ABRAHAM,  GIRLEY T              110064\n10 ABRAMSKI,  JOHN E               128970\n# ℹ 6,081 more rows\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.python .cell-code}\ndf[df['salary_annual'] > 100000][['name', 'salary_annual']]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                        name  salary_annual\n0          AARON,  JEFFERY M       101442.0\n2        AARON,  KIMBERLEI R       101592.0\n3        ABAD JR,  VICENTE M       110064.0\n9      ABBATEMARCO,  JAMES J       103350.0\n14       ABDELLATIF,  AREF R       102228.0\n...                      ...            ...\n32783         ZUPAN,  BILL M       114324.0\n32785     ZURAWSKI,  JEFFREY       101608.0\n32794    ZWOLFER,  MATTHEW W       114324.0\n32798    ZYGADLO,  MICHAEL J       101608.0\n32805    ZYSKOWSKI,  DARIUSZ       115932.0\n\n[6091 rows x 2 columns]\n```\n\n\n:::\n:::\n\n\n**Find all employees who work in the \"FINANCE\" department.**\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nselect name\nfrom df\nwhere department = 'FINANCE'\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: Displaying records 1 - 10\n\n|name                   |\n|:----------------------|\n|ADAMCZYK JR,  JAN      |\n|ADAPON,  NENITA P      |\n|ADENI,  MOHAMED K      |\n|AHMED,  MOHAMMAD A     |\n|AIKONEDO,  PAUL E      |\n|ALAM,  SYED S          |\n|ALEXANDER,  PATRICIA L |\n|ALEXANDER,  RACQUEL L  |\n|ALLEN,  JONATHAN E     |\n|ALLEN,  KEVIN M        |\n\n</div>\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  filter(department == 'FINANCE') %>% \n  select(name)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 563 × 1\n   name                  \n   <chr>                 \n 1 ADAMCZYK JR,  JAN     \n 2 ADAPON,  NENITA P     \n 3 ADENI,  MOHAMED K     \n 4 AHMED,  MOHAMMAD A    \n 5 AIKONEDO,  PAUL E     \n 6 ALAM,  SYED S         \n 7 ALEXANDER,  PATRICIA L\n 8 ALEXANDER,  RACQUEL L \n 9 ALLEN,  JONATHAN E    \n10 ALLEN,  KEVIN M       \n# ℹ 553 more rows\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.python .cell-code}\ndf[df['department'] == 'FINANCE']['name']\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n109         ADAMCZYK JR,  JAN\n162         ADAPON,  NENITA P\n175         ADENI,  MOHAMED K\n263        AHMED,  MOHAMMAD A\n278         AIKONEDO,  PAUL E\n                 ...         \n32498    ZACARIAZ,  ALEJANDRO\n32522          ZAIDI,  SYED K\n32605       ZAVALA,  FERNANDO\n32680          ZHANG,  KEFENG\n32789          ZUREK,  MARY H\nName: name, Length: 563, dtype: object\n```\n\n\n:::\n:::\n\n\n# 2. Aggregate Functions:\n\n**Calculate the average salary for all employees.**\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nselect avg(salary_annual)\nfrom df\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: 1 records\n\n| avg(salary_annual)|\n|------------------:|\n|           81631.46|\n\n</div>\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>%\n  summarize(mean(salary_annual))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 1\n  `mean(salary_annual)`\n                  <dbl>\n1                81631.\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.python .cell-code}\ndf['salary_annual'].mean()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nnp.float64(81631.4588758154)\n```\n\n\n:::\n:::\n\n\n**Find the total number of employees in each department.**\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nselect department, count(*) as ttl_employees\nfrom df\ngroup by department\norder by ttl_employees desc\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: Displaying records 1 - 10\n\n|department              | ttl_employees|\n|:-----------------------|-------------:|\n|POLICE                  |         13055|\n|FIRE                    |          4833|\n|OEMC                    |          2121|\n|STREETS & SAN           |          2045|\n|WATER MGMNT             |          1902|\n|AVIATION                |          1414|\n|TRANSPORTN              |          1244|\n|PUBLIC LIBRARY          |           978|\n|FLEET AND FACILITY MGMT |           964|\n|FAMILY & SUPPORT        |           625|\n\n</div>\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  group_by(department) %>%\n  count() %>% \n  arrange(-n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 36 × 2\n# Groups:   department [36]\n   department                  n\n   <chr>                   <int>\n 1 POLICE                  13055\n 2 FIRE                     4833\n 3 OEMC                     2121\n 4 STREETS & SAN            2045\n 5 WATER MGMNT              1902\n 6 AVIATION                 1414\n 7 TRANSPORTN               1244\n 8 PUBLIC LIBRARY            978\n 9 FLEET AND FACILITY MGMT   964\n10 FAMILY & SUPPORT          625\n# ℹ 26 more rows\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.python .cell-code}\ndf.groupby('department').agg(\n  ttl_employees = ('name', 'count')\n).reset_index().sort_values(by='ttl_employees', ascending=False)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                 department  ttl_employees\n27                   POLICE          13055\n15                     FIRE           4833\n26                     OEMC           2121\n31            STREETS & SAN           2045\n34              WATER MGMNT           1902\n2                  AVIATION           1414\n32               TRANSPORTN           1244\n30           PUBLIC LIBRARY            978\n16  FLEET AND FACILITY MGMT            964\n13         FAMILY & SUPPORT            625\n14                  FINANCE            563\n17                   HEALTH            503\n9              CITY COUNCIL            453\n23                      LAW            392\n6                 BUILDINGS            277\n18       HOUSING & ECON DEV            204\n7          BUSINESS AFFAIRS            161\n3         BOARD OF ELECTION            103\n12                     DoIT             98\n29              PROCUREMENT             97\n21            INSPECTOR GEN             89\n8                CITY CLERK             89\n25           MAYOR'S OFFICE             86\n1             ANIMAL CONTRL             80\n20          HUMAN RESOURCES             71\n10         CULTURAL AFFAIRS             67\n5             BUDGET & MGMT             46\n0              ADMIN HEARNG             39\n11             DISABILITIES             29\n33                TREASURER             22\n19          HUMAN RELATIONS             17\n22                     IPRA             13\n4           BOARD OF ETHICS              8\n28             POLICE BOARD              2\n24        LICENSE APPL COMM              1\n```\n\n\n:::\n:::\n\n\n**Determine the highest salary in the dataset.**\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nselect max(salary_annual)\nfrom df\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: 1 records\n\n| max(salary_annual)|\n|------------------:|\n|              3e+05|\n\n</div>\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  summarize(max(salary_annual))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 1\n  `max(salary_annual)`\n                 <dbl>\n1               300000\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.python .cell-code}\ndf['salary_annual'].max()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nnp.float64(300000.0)\n```\n\n\n:::\n:::\n\n\n# 3. Grouping and Sorting:\n\n**List the average salary for each job title.**\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nselect title, avg(salary_annual) as avg_salary\nfrom df\ngroup by title\norder by avg_salary desc\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: Displaying records 1 - 10\n\n|title                          | avg_salary|\n|:------------------------------|----------:|\n|COMMISSIONER OF AVIATION       |     300000|\n|SUPERINTENDENT OF POLICE       |     260004|\n|MAYOR                          |     216210|\n|FIRE COMMISSIONER              |     202728|\n|FIRST DEPUTY FIRE COMMISSIONER |     197736|\n|FIRST DEPUTY SUPERINTENDENT    |     197724|\n|CHIEF OF STAFF                 |     195000|\n|DEPUTY FIRE COMMISSIONER       |     187680|\n|CHIEF                          |     185364|\n|ASST DEPUTY FIRE COMMISSIONER  |     185352|\n\n</div>\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  group_by(title) %>% \n  summarize(avg_salary = mean(salary_annual, na.rm = TRUE)) %>% \n  arrange(-avg_salary)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1,121 × 2\n   title                          avg_salary\n   <chr>                               <dbl>\n 1 COMMISSIONER OF AVIATION           300000\n 2 SUPERINTENDENT OF POLICE           260004\n 3 MAYOR                              216210\n 4 FIRE COMMISSIONER                  202728\n 5 FIRST DEPUTY FIRE COMMISSIONER     197736\n 6 FIRST DEPUTY SUPERINTENDENT        197724\n 7 CHIEF OF STAFF                     195000\n 8 DEPUTY FIRE COMMISSIONER           187680\n 9 CHIEF                              185364\n10 ASST DEPUTY FIRE COMMISSIONER      185352\n# ℹ 1,111 more rows\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.python .cell-code}\ndf.groupby('title').agg(\n  avg_salary = ('salary_annual', 'mean')\n).reset_index().sort_values(by='avg_salary', ascending=False)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                               title     avg_salary\n252         COMMISSIONER OF AVIATION  300000.000000\n997         SUPERINTENDENT OF POLICE  260004.000000\n731                            MAYOR  216210.000000\n516                FIRE COMMISSIONER  202728.000000\n539   FIRST DEPUTY FIRE COMMISSIONER  197736.000000\n...                              ...            ...\n785                     POLICE CADET    9838.400000\n828                     PROGRAM AIDE    9728.622222\n1077       TITLE V PROGRAM TRAINEE I    8580.000000\n576               FOSTER GRANDPARENT    2756.000000\n915                 SENIOR COMPANION    2756.000000\n\n[1121 rows x 2 columns]\n```\n\n\n:::\n:::\n\n\n**Find the top 5 highest-paid departments.**\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nselect department, avg(salary_annual) as avg_salary\nfrom df\ngroup by department\norder by avg_salary desc\nlimit 5\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: 5 records\n\n|department      | avg_salary|\n|:---------------|----------:|\n|IPRA            |  102758.77|\n|DoIT            |   99220.53|\n|BUILDINGS       |   99095.58|\n|FIRE            |   98203.67|\n|BOARD OF ETHICS |   95061.00|\n\n</div>\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  group_by(department) %>% \n  summarize(avg_salary = mean(salary_annual)) %>% \n  top_n(5, avg_salary) %>% \n  arrange(-avg_salary)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 × 2\n  department      avg_salary\n  <chr>                <dbl>\n1 IPRA               102759.\n2 DoIT                99221.\n3 BUILDINGS           99096.\n4 FIRE                98204.\n5 BOARD OF ETHICS     95061 \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.python .cell-code}\ndf.groupby('department').agg(\n  avg_salary = ('salary_annual', 'mean')\n).reset_index().sort_values(by='avg_salary', ascending=False).head(5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n         department     avg_salary\n22             IPRA  102758.769231\n12             DoIT   99220.530612\n6         BUILDINGS   99095.580650\n15             FIRE   98203.672849\n4   BOARD OF ETHICS   95061.000000\n```\n\n\n:::\n:::\n\n\n**Show the number of employees for each job title, ordered by the number of employees in descending order.**\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nselect title, count(*) as cnt_employees\nfrom df\ngroup by title\norder by cnt_employees desc\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: Displaying records 1 - 10\n\n|title                                  | cnt_employees|\n|:--------------------------------------|-------------:|\n|POLICE OFFICER                         |          9213|\n|FIREFIGHTER-EMT                        |          1492|\n|SERGEANT                               |          1162|\n|POLICE OFFICER (ASSIGNED AS DETECTIVE) |          1015|\n|MOTOR TRUCK DRIVER                     |           709|\n|POOL MOTOR TRUCK DRIVER                |           693|\n|SANITATION LABORER                     |           634|\n|FIREFIGHTER                            |           533|\n|CROSSING GUARD                         |           464|\n|CONSTRUCTION LABORER                   |           456|\n\n</div>\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  group_by(title) %>% \n  count() %>% \n  arrange(-n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1,121 × 2\n# Groups:   title [1,121]\n   title                                      n\n   <chr>                                  <int>\n 1 POLICE OFFICER                          9213\n 2 FIREFIGHTER-EMT                         1492\n 3 SERGEANT                                1162\n 4 POLICE OFFICER (ASSIGNED AS DETECTIVE)  1015\n 5 MOTOR TRUCK DRIVER                       709\n 6 POOL MOTOR TRUCK DRIVER                  693\n 7 SANITATION LABORER                       634\n 8 FIREFIGHTER                              533\n 9 CROSSING GUARD                           464\n10 CONSTRUCTION LABORER                     456\n# ℹ 1,111 more rows\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.python .cell-code}\ndf.groupby('title').agg(\n  cnt_employees = ('name', 'count')\n).reset_index().sort_values(by='cnt_employees', ascending=False)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                                      title  cnt_employees\n791                          POLICE OFFICER           9213\n529                         FIREFIGHTER-EMT           1492\n946                                SERGEANT           1162\n796  POLICE OFFICER (ASSIGNED AS DETECTIVE)           1015\n744                      MOTOR TRUCK DRIVER            709\n..                                      ...            ...\n218                CHIEF SYSTEMS PROGRAMMER              1\n220                     CHIEF WATER CHEMIST              1\n221                    CHIEF WATER ENGINEER              1\n222              CHIEF ZONING PLAN EXAMINER              1\n0              1ST DEPUTY INSPECTOR GENERAL              1\n\n[1121 rows x 2 columns]\n```\n\n\n:::\n:::\n\n\n# 4. Joining and Subqueries:\n\n**Retrieve the details of employees who have the same job title as the employee with the highest salary.**\n\n*Passing on question for now -- unclear*\n\n**Find the names of employees who earn more than the average salary.**\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  mutate(avg_salary = mean(salary_annual)) %>% \n  filter(salary_annual > avg_salary)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 19,902 × 9\n   name                  title      department salary_annual original_hire_date \n   <chr>                 <chr>      <chr>              <dbl> <dttm>             \n 1 AARON,  JEFFERY M     SERGEANT   POLICE            101442 2005-09-26 00:00:00\n 2 AARON,  KARINA        POLICE OF… POLICE             94122 2005-09-26 00:00:00\n 3 AARON,  KIMBERLEI R   CHIEF CON… FLEET AND…        101592 1991-08-01 00:00:00\n 4 ABAD JR,  VICENTE M   CIVIL ENG… WATER MGM…        110064 1994-12-01 00:00:00\n 5 ABBATACOLA,  ROBERT J ELECTRICA… AVIATION           95888 1997-10-16 00:00:00\n 6 ABBATEMARCO,  JAMES J FIRE ENGI… FIRE              103350 2000-07-17 00:00:00\n 7 ABBATE,  TERRY M      POLICE OF… POLICE             93354 1995-12-04 00:00:00\n 8 ABDALLAH,  ZAID       POLICE OF… POLICE             84054 2012-11-30 00:00:00\n 9 ABDELHADI,  ABDALMAHD POLICE OF… POLICE             87006 2006-12-18 00:00:00\n10 ABDELLATIF,  AREF R   FIREFIGHT… FIRE              102228 2003-11-03 00:00:00\n# ℹ 19,892 more rows\n# ℹ 4 more variables: start_date_in_present_position <dttm>,\n#   salary_basis <chr>, employment_category <chr>, avg_salary <dbl>\n```\n\n\n:::\n:::\n\n\n\n\n5. Complex Queries:\n\n**Calculate the percentage of employees in each department relative to the total number of employees.**\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nwith dept_employees as (\n  select department, count(*) cnt_employees\n  from df\n  group by department\n),\nttl_employees as (\n  select count(*) as ttl_count\n  from df\n)\nselect *, round(cnt_employees * 100.0 / ttl_count, 1) as pct_employees\nfrom dept_employees, ttl_employees\norder by pct_employees desc\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: Displaying records 1 - 10\n\n|department              | cnt_employees| ttl_count| pct_employees|\n|:-----------------------|-------------:|---------:|-------------:|\n|POLICE                  |         13055|     32806|          39.8|\n|FIRE                    |          4833|     32806|          14.7|\n|OEMC                    |          2121|     32806|           6.5|\n|STREETS & SAN           |          2045|     32806|           6.2|\n|WATER MGMNT             |          1902|     32806|           5.8|\n|AVIATION                |          1414|     32806|           4.3|\n|TRANSPORTN              |          1244|     32806|           3.8|\n|PUBLIC LIBRARY          |           978|     32806|           3.0|\n|FLEET AND FACILITY MGMT |           964|     32806|           2.9|\n|FAMILY & SUPPORT        |           625|     32806|           1.9|\n\n</div>\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  group_by(department) %>% \n  count() %>% \n  ungroup() %>% \n  mutate(ttl_employees = sum(n),\n         pct_employees = round((n / ttl_employees) * 100, 1)) %>% \n  arrange(-pct_employees)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 36 × 4\n   department                  n ttl_employees pct_employees\n   <chr>                   <int>         <int>         <dbl>\n 1 POLICE                  13055         32806          39.8\n 2 FIRE                     4833         32806          14.7\n 3 OEMC                     2121         32806           6.5\n 4 STREETS & SAN            2045         32806           6.2\n 5 WATER MGMNT              1902         32806           5.8\n 6 AVIATION                 1414         32806           4.3\n 7 TRANSPORTN               1244         32806           3.8\n 8 PUBLIC LIBRARY            978         32806           3  \n 9 FLEET AND FACILITY MGMT   964         32806           2.9\n10 FAMILY & SUPPORT          625         32806           1.9\n# ℹ 26 more rows\n```\n\n\n:::\n:::\n\n\n**Identify job titles that have more than 100 employees.**\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nselect title, count(*) cnt_employees\nfrom df\ngroup by title\nhaving cnt_employees > 100\norder by cnt_employees desc\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: Displaying records 1 - 10\n\n|title                                  | cnt_employees|\n|:--------------------------------------|-------------:|\n|POLICE OFFICER                         |          9213|\n|FIREFIGHTER-EMT                        |          1492|\n|SERGEANT                               |          1162|\n|POLICE OFFICER (ASSIGNED AS DETECTIVE) |          1015|\n|MOTOR TRUCK DRIVER                     |           709|\n|POOL MOTOR TRUCK DRIVER                |           693|\n|SANITATION LABORER                     |           634|\n|FIREFIGHTER                            |           533|\n|CROSSING GUARD                         |           464|\n|CONSTRUCTION LABORER                   |           456|\n\n</div>\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  group_by(title) %>% \n  count() %>% \n  filter(n > 100) %>% \n  arrange(-n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 46 × 2\n# Groups:   title [46]\n   title                                      n\n   <chr>                                  <int>\n 1 POLICE OFFICER                          9213\n 2 FIREFIGHTER-EMT                         1492\n 3 SERGEANT                                1162\n 4 POLICE OFFICER (ASSIGNED AS DETECTIVE)  1015\n 5 MOTOR TRUCK DRIVER                       709\n 6 POOL MOTOR TRUCK DRIVER                  693\n 7 SANITATION LABORER                       634\n 8 FIREFIGHTER                              533\n 9 CROSSING GUARD                           464\n10 CONSTRUCTION LABORER                     456\n# ℹ 36 more rows\n```\n\n\n:::\n:::\n\n\n**Find employees who have been in their current position for more than 5 years (assuming the dataset includes a hire date or a similar field).**\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf %>% \n  mutate(tenure = round(\n    lubridate::time_length(\n    today() - lubridate::as_date(start_date_in_present_position), \"year\"),\n    1)) %>% \n  filter(tenure > 5) %>% \n  arrange(-tenure)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 32,806 × 9\n   name                title        department salary_annual original_hire_date \n   <chr>               <chr>        <chr>              <dbl> <dttm>             \n 1 LANNON,  JOHN P     CONSTRUCTIO… WATER MGM…        83616  1963-07-02 00:00:00\n 2 WILLIAMS,  DAISY    CROSSING GU… OEMC              23254. 1965-12-06 00:00:00\n 3 CALHOUN,  ROCKELL H CROSSING GU… OEMC              23254. 1968-03-25 00:00:00\n 4 SCOTT,  ROSIE M     PARKING ENF… FINANCE           64392  1968-08-19 00:00:00\n 5 BURKE,  CATHERINE   CROSSING GU… OEMC              23254. 1970-05-13 00:00:00\n 6 BISHOP,  DORIS J    LIBRARY ASS… PUBLIC LI…        69492  1971-09-07 00:00:00\n 7 LUMPKIN,  STEPHEN   SANITATION … STREETS &…        75317. 1972-03-11 00:00:00\n 8 KUCHARSKI,  JOYCE M CROSSING GU… OEMC              23254. 1973-09-17 00:00:00\n 9 CORSO JR,  JOHN J   PROPERTY CU… POLICE            70092  1975-05-27 00:00:00\n10 PHILLIPS,  EUGENIA  CROSSING GU… OEMC              23254. 1976-01-12 00:00:00\n# ℹ 32,796 more rows\n# ℹ 4 more variables: start_date_in_present_position <dttm>,\n#   salary_basis <chr>, employment_category <chr>, tenure <dbl>\n```\n\n\n:::\n:::\n\n\n# 6. Own Questions\n\n**Pull the second title of all employees that have had more than one title.**\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nwith promotion_seq as (\n      select\n          name,\n          start_date_in_present_position,\n          ROW_NUMBER() OVER(\n            partition by name\n            order by start_date_in_present_position\n          ) as seq_promotion\n      from df\n)\nselect *\nfrom promotion_seq\nwhere seq_promotion = 2\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: Displaying records 1 - 10\n\n|name                | start_date_in_present_position| seq_promotion|\n|:-------------------|------------------------------:|-------------:|\n|ADE,  JAMES P       |                     1283299200|             2|\n|ANDERSON,  DAVID C  |                     1393200000|             2|\n|ANDERSON,  DONALD   |                     1494806400|             2|\n|ANDERSON,  RHONDA M |                     1464739200|             2|\n|ARROYO,  FRANCISCO  |                     1489622400|             2|\n|ATECA,  SALVADOR R  |                     1425340800|             2|\n|BIANCHI,  MICHAEL J |                     1502841600|             2|\n|BRACKEN,  DANIEL J  |                     1418688000|             2|\n|BROWN,  ANTHONY     |                     1405296000|             2|\n|BROWN,  PATRICK J   |                     1429142400|             2|\n\n</div>\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# need to think about how it's done with R\ndf %>% \n  group_by(name) %>% \n  count() %>% \n  arrange(-n) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 32,498 × 2\n# Groups:   name [32,498]\n   name                   n\n   <chr>              <int>\n 1 HERNANDEZ,  JUAN C     4\n 2 KELLY,  MICHAEL J      4\n 3 PEREZ,  JOSE A         4\n 4 RIVERA,  RICARDO       4\n 5 ROMERO,  MIGUEL A      4\n 6 DELGADO,  JUAN         3\n 7 DIAZ,  ENRIQUE         3\n 8 GARCIA,  DAVID         3\n 9 GARCIA,  GABRIEL       3\n10 GONZALEZ,  DAVID       3\n# ℹ 32,488 more rows\n```\n\n\n:::\n:::\n\n\n**How much, on average, do people see in terms of a salary bump after their promotion?**\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nwith promotion_seq as (\n      select\n          name,\n          salary_annual,\n          start_date_in_present_position,\n          ROW_NUMBER() OVER(\n            partition by name\n            order by start_date_in_present_position\n          ) as seq_promotion\n      from df\n),\nsalary_change as (select *,\n        salary_annual - LAG(salary_annual, 1, salary_annual) OVER(\n            partition by name\n            order by start_date_in_present_position\n          ) as salary_diff\nfrom df\n)\nselect *\nfrom salary_change\nwhere salary_diff != 0\norder by salary_diff desc\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: Displaying records 1 - 10\n\n|name                |title                      |department  | salary_annual| original_hire_date| start_date_in_present_position|salary_basis |employment_category | salary_diff|\n|:-------------------|:--------------------------|:-----------|-------------:|------------------:|------------------------------:|:------------|:-------------------|-----------:|\n|JOHNSON,  KENNETH A |COMMANDER                  |POLICE      |      162684.0|          529545600|                     1473984000|SALARY       |Fulltime-Regular    |     73536.0|\n|HERNANDEZ,  JUAN C  |DISTRICT CHIEF             |FIRE        |      170112.0|          834969600|                     1328054400|SALARY       |Fulltime-Regular    |     73128.0|\n|HOWARD,  PATRICIA A |ADMINISTRATIVE ASST III    |TRANSPORTN  |       84420.0|          639014400|                     1009843200|SALARY       |Fulltime-Regular    |     65159.2|\n|GONZALEZ,  GEORGE A |CAPTAIN-EMT                |FIRE        |      136794.0|          540518400|                     1429142400|SALARY       |Fulltime-Regular    |     62746.0|\n|HALL,  PAMELA D     |CONSTRUCTION LABORER       |WATER MGMNT |       83616.0|         1336953600|                     1336953600|HOURLY 40    |Fulltime-Regular    |     62493.6|\n|ANDERSON,  RHONDA M |SERGEANT                   |POLICE      |      104628.0|          951696000|                     1464739200|SALARY       |Fulltime-Regular    |     60984.0|\n|RYAN,  SEAN         |HOISTING ENGINEER          |WATER MGMNT |      102128.0|         1480896000|                     1488844800|HOURLY 40    |Fulltime-Temporary  |     54050.0|\n|GARCIA,  JESUS      |LIEUTENANT-PARAMEDIC       |FIRE        |      124728.0|          667785600|                     1450224000|SALARY       |Fulltime-Regular    |     52218.0|\n|HAYNES,  DAVID J    |LIEUTENANT                 |POLICE      |      121464.0|          805334400|                     1346457600|SALARY       |Fulltime-Regular    |     47472.0|\n|O'BRIEN,  MICHAEL   |OPERATING ENGINEER-GROUP C |WATER MGMNT |       93745.6|         1481846400|                     1481846400|HOURLY 40    |Fulltime-Regular    |     45667.6|\n\n</div>\n:::\n\n::: {.cell}\n\n:::\n\n\n**Extension of this question to remove changes in employment type or salary basis.**\n\n\n\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}