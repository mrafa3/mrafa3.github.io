{
  "hash": "ecc42eddb6bdd9d19f22761e44902774",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Analysis of Gapminder data using nested models in R\"\ndescription: \"This post outlines the value in building nested models using the purrr and broom packages\"\nauthor:\n  - name: Mickey Rafa\n    url: https://mrafa3.github.io/\n    #orcid: 0000-0002-5300-3075\ndate: 10-01-2017\ncategories: [R, regression, data-viz, tidyverse, international-development] # self-defined categories\n#citation: \n # url: https://mrafa3.github.io/posts/2024-07-15-wikipedia-international-mens-soccer/ \nimage: model_fit_plot.png\ndraft: false # setting this to `true` will prevent your post from appearing on your listing page until you're ready!\n---\n\n\nWorking on nesting models following the workflow from **R for Data Science**.\n\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n        country        continent        year         lifeExp     \n Afghanistan:  12   Africa  :624   Min.   :1952   Min.   :23.60  \n Albania    :  12   Americas:300   1st Qu.:1966   1st Qu.:48.20  \n Algeria    :  12   Asia    :396   Median :1980   Median :60.71  \n Angola     :  12   Europe  :360   Mean   :1980   Mean   :59.47  \n Argentina  :  12   Oceania : 24   3rd Qu.:1993   3rd Qu.:70.85  \n Australia  :  12                  Max.   :2007   Max.   :82.60  \n (Other)    :1632                                                \n      pop              gdpPercap       \n Min.   :6.001e+04   Min.   :   241.2  \n 1st Qu.:2.794e+06   1st Qu.:  1202.1  \n Median :7.024e+06   Median :  3531.8  \n Mean   :2.960e+07   Mean   :  7215.3  \n 3rd Qu.:1.959e+07   3rd Qu.:  9325.5  \n Max.   :1.319e+09   Max.   :113523.1  \n                                       \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#create year_since_1950\ngapminder <- gapminder %>% \n  mutate(year_since_1950 = year - 1950)\n#group by data that you want to produce multiple models by\n#then nest to create data column of remaining columns\nnest_gapminder <- gapminder %>% \n  group_by(continent, country) %>% \n  nest()\n\n#create function for model that you want to build\n#df will be the only parametre\ncontinent_year_model <- function(df) {\n  lm(lifeExp ~ year_since_1950, data = df)\n}\n\n#take nested df and map function to the data column\n#model will keep nested model statistics by country/year\nnest_gapminder <- nest_gapminder %>% \n  mutate(model = map(data, continent_year_model),\n         glance = map(model, broom::glance))\n\nglance_gapminder_model <- nest_gapminder %>% \n  unnest(glance) %>% \n  arrange(desc(adj.r.squared))\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nglance_gapminder_model %>% \n  ggplot(.) + \n  geom_jitter(aes(x=continent,\n                 y=r.squared,\n                 color=continent)) + \n  ggtitle('Distribution of model fit by continent',\n          subtitle = 'Each dot is a country model') + \n  labs(x='Continent',\n       y='R-squared',\n       caption='LifeExp ~ year') + \n  my.theme\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/visualize_models-1.png){fig-align='center' width=960}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nglance_gapminder_model %>% \n  ggplot(.) + \n  geom_density_ridges(aes(x=r.squared, \n                          y=continent,\n                          fill=continent)) + \n  ggtitle('Distribution of model fits by continent',\n          subtitle = 'Time does not explain variance in African life expectancy as strongly as others') + \n  labs(x='R-squared',\n       y='Continent',\n       caption='LifeExp ~ year') + \n  my.theme\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nPicking joint bandwidth of 0.0392\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/joyplot_nested_model_fit-1.png){fig-align='center' width=960}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n#which countries have the poor fits?\nbad_fit <- glance_gapminder_model %>% filter(r.squared < 0.4)\n\ngapminder %>% \n  semi_join(bad_fit, by = \"country\") %>% \n  ggplot(.) + \n    geom_line(aes(x=year, \n                  y=lifeExp, \n                  color=country), linewidth=1.1) + \n  ggtitle('Countries in which time does not adequately explain life expectancy',\n          subtitle = 'Visualizing countries with model fits less than .4') + \n  labs(x='Year',\n       y='Life expectancy',\n       caption='LifeExp ~ year') + \n  my.theme\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/bad_fit-1.png){fig-align='center' width=960}\n:::\n:::\n\n\nThis demonstrates that:  \n\n*  The 10 countries with the poorest model fits are all in Africa.  \n*  The fit seems to be due to a dramatic decline in life expectancy that begins around 1990. This is the HIV/AIDS epidemic.  \nFrom R for Data Science (http://r4ds.had.co.nz/many-models.html#making-tidy-data-with-broom):  \n\n**Making tidy data with broom**:  \n\nThe broom package provides three general tools for turning models into tidy data frames:  \n\n*  broom::glance(model) returns a row for each model. Each column gives a model summary: either a measure of model quality, or complexity, or a combination of the two.  \n*  broom::tidy(model) returns a row for each coefficient in the model. Each column gives information about the estimate or its variability.  \n*  broom::augment(model, data) returns a row for each row in data, adding extra values like residuals, and influence statistics.  ",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}